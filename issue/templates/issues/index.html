<%!
    def strip_tags(html, invalid_tags):
        from BeautifulSoup import BeautifulSoup, NavigableString
        soup = BeautifulSoup(html)
        for tag in soup.findAll(True):
            if tag.name in invalid_tags:
                s = ""
                for c in tag.contents:
                    if not isinstance(c, NavigableString):
                        c = strip_tags(unicode(c), invalid_tags)
                    s += unicode(c)
                tag.replaceWith(s)
        return soup.text

    def puretext(text):
        invalidTags = ['b', 'i', 'u']
        return strip_tags(text,invalidTags)

    def summary(text):
        limit = 200
        result = text[:min(len(text), limit-3)]
        if len(text) > limit-3: result += "..."
        return result

    def images(text):
        from BeautifulSoup import BeautifulSoup
        soup = BeautifulSoup(text)
        imgs = [str(e) for e in set([img['src'] for img in soup('img')])]
        template = """<img class="issue_image" src='%s' style='width:120px;'>"""
        #return ''.join([template%(e) for e in imgs])
        if len(imgs) > 0 :
        	return template % (imgs[0])
        else : return ""
%>

<%inherit file="/base.html"/>
<%block name="head">
${parent.head()}
<style type="text/css">
table {border-collapse: collapse; width: 100%}
table td { }
table th { text-align: left; }
.issue_title a {
    font-family: "NanumGothic", "나눔고딕";
    font-size: 30px;
    font-weight:bold;
    background-color: transparent;
    color: #000000;
    border: 1px solid #cccccc;
}

.issue_image {

    border: 1px solid #cccccc;
}

.issue_content {
    font-family: "NanumGothic", "나눔고딕";
    line-height: 1.5em;
    font-size: 14px;
    font-weight:bold;
    background-color: transparent;
    color: #000000;
    border: 1px solid #cccccc;
}

.issue_info {
    font-family: "NanumGothic", "나눔고딕";
    font-size: 14px;
    font-weight:bold;
    background-color: transparent;
    color: #000000;
    text-align: right;
    border: 1px solid #cccccc;
}

.issue_info ul {
    list-style: none;
    padding: 8px;
    margin: 4px;
    border: 1px solid #cccccc;
}

.writer_avatar {
    float: right;
    margin: 4px;
    border: 1px solid #cccccc;
}
</style>
</%block>
% if 'tag' in request.GET:
    <div>Tag : ${request.GET['tag']}</div>
% endif
<table>
<tbody>
% for item in objects:
<tr>
    <td>
        <table>
            <tr>
                <td colspan=2><span class="issue_title"><a href="/issues/${item.id}">${item.title}</a></span></td>
            </tr>
            <tr>
                <td>
                    <div class="issue_content">${item.content|puretext,summary}</div>
                    <div class="issue_info">
                        % if request.user.is_authenticated():
                            ${self.helper.avatar(item.writer)}
                        % endif
                        <ul>
                        <li>${item.writer}
                        <li>${item.updated}
                        </ul>
                    </div>
                </td>
				<td>${item.content|images}</td>
            </tr>
        </table>
    </td>

</tr>
% endfor
</tbody>
</table>
